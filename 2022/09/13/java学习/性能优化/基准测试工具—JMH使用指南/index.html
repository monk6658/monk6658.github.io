<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JMH使用指南 | 小明的博客</title>
  <meta name="keywords" content=" 基准测试工具 , JMH ">
  <meta name="description" content="JMH使用指南 | 小明的博客">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Java 代码性能测试的工具，JMH只适合细粒度的方法测试，并不适用于系统之间的链路测试.">
<meta property="og:type" content="article">
<meta property="og:title" content="JMH使用指南">
<meta property="og:url" content="https://monk6658.github.io/2022/09/13/java%E5%AD%A6%E4%B9%A0/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E2%80%94JMH%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="小明的博客">
<meta property="og:description" content="Java 代码性能测试的工具，JMH只适合细粒度的方法测试，并不适用于系统之间的链路测试.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-12T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-14T09:30:46.624Z">
<meta property="article:author" content="小明同鞋">
<meta property="article:tag" content="基准测试工具">
<meta property="article:tag" content="JMH">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/head.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/head.jpg" />
</a>
<div class="author">
    <span>小明同鞋</span>
</div>

<div class="icon">
    
        
        <a title="github" href="https://github.com/monk6658" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=1245141646&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
        <a title="email" href="mailto:monk6658@163.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active" data-rel="All">All<small>(27)</small></div></li>
    
        
            
            <li><div data-rel="工具">工具<small>(7)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="并发">并发<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="并发、netty">并发、netty<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="算法">算法<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="小程序">小程序<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="中间件">中间件<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="docker">docker<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="JAVA">JAVA<small>(8)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="JVM">JVM<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Linux">Linux<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="mysql">mysql<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="oracle">oracle<small>(2)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a  class="friends">Friends</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="27">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">原hexo主题博主</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>按位与</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>并发</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>博客</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>分包粘包</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>函数</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>基准测试工具</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>面试</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>排序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>哨兵</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>死锁</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>锁机制</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>锁netty</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>微信支付</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>位运算</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>小程序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>异常</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>运维</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>支付宝</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>中间件</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>主从</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>centos</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>cer</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Comparable</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Comparator</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>docker</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Erlang</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>FinalAgent</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>frp</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hexo</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java调用c++方法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jdk</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JMH</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JNA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JvisualVm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JVM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>mongodb</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>mysql</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nodeJs</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nosql</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>oracle</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pfx</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pycharm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RabbitMQ</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>redis</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RSA分段</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>sql</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tag2</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tag3</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="All JAVA "
           href="/2022/09/13/java%E5%AD%A6%E4%B9%A0/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E2%80%94JMH%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"
           data-tag="基准测试工具,JMH"
           data-author="" >
            <span class="post-title" title="JMH使用指南">JMH使用指南</span>
            <span class="post-date" title="2022-09-13 00:00:00">2022/09/13</span>
        </a>
        
        <a  class="All mysql "
           href="/2022/06/10/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/mysql/mysql%E8%AF%A6%E8%A7%A3/"
           data-tag="sql,mysql,函数"
           data-author="" >
            <span class="post-title" title="mysql操作">mysql操作</span>
            <span class="post-date" title="2022-06-10 00:00:00">2022/06/10</span>
        </a>
        
        <a  class="All 工具 "
           href="/2022/05/28/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/ide%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E5%8F%8A%E7%A0%B4%E8%A7%A3/pycharm2021.3/"
           data-tag="pycharm,FinalAgent"
           data-author="" >
            <span class="post-title" title="pycharm 安装及破解">pycharm 安装及破解</span>
            <span class="post-date" title="2022-05-28 14:16:33">2022/05/28</span>
        </a>
        
        <a  class="All 算法 "
           href="/2022/03/24/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"
           data-tag="算法,java"
           data-author="" >
            <span class="post-title" title="算法学习">算法学习</span>
            <span class="post-date" title="2022-03-24 14:16:33">2022/03/24</span>
        </a>
        
        <a  class="All 工具 "
           href="/2021/11/24/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/mongodb/mongodb%E5%AE%89%E8%A3%85%E5%8F%8A%E5%AD%A6%E4%B9%A0/"
           data-tag="mongodb,nosql"
           data-author="" >
            <span class="post-title" title="mongodb安装及学习">mongodb安装及学习</span>
            <span class="post-date" title="2021-11-24 00:00:00">2021/11/24</span>
        </a>
        
        <a  class="All 工具 "
           href="/2021/11/06/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/nodeJs%E4%BD%BF%E7%94%A8/nodeJs%E5%AE%89%E8%A3%85%E5%8F%8A%E5%91%A8%E8%BE%B9%E5%AE%89%E8%A3%85/"
           data-tag="hexo,nodeJs"
           data-author="" >
            <span class="post-title" title="nodeJs安装及周边安装">nodeJs安装及周边安装</span>
            <span class="post-date" title="2021-11-06 00:00:00">2021/11/06</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/06/17/java%E5%AD%A6%E4%B9%A0/jvm/NullPointerException%20%E6%B2%A1%E6%9C%89%E6%89%93%E5%8D%B0%E5%BC%82%E5%B8%B8%E6%A0%88%E9%97%AE%E9%A2%98%E8%BF%BD%E8%B8%AA/"
           data-tag="JVM,异常"
           data-author="" >
            <span class="post-title" title="NullPointerException 没有打印异常栈问题追踪">NullPointerException 没有打印异常栈问题追踪</span>
            <span class="post-date" title="2021-06-17 14:16:33">2021/06/17</span>
        </a>
        
        <a  class="All 中间件 "
           href="/2021/06/05/%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitmq/RabbitMQ%E4%BD%BF%E7%94%A8/"
           data-tag="中间件,RabbitMQ"
           data-author="" >
            <span class="post-title" title="RabbitMQ 实战">RabbitMQ 实战</span>
            <span class="post-date" title="2021-06-05 14:16:33">2021/06/05</span>
        </a>
        
        <a  class="All Linux "
           href="/2021/06/05/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/linux/centos%20%E5%AE%89%E8%A3%85%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E6%94%AF%E6%8C%81/"
           data-tag="RabbitMQ,jdk,Erlang,frp,centos"
           data-author="" >
            <span class="post-title" title="centos 安装基本环境支持">centos 安装基本环境支持</span>
            <span class="post-date" title="2021-06-05 14:16:33">2021/06/05</span>
        </a>
        
        <a  class="All docker "
           href="/2021/06/05/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/linux/Docker%20%E5%A4%A7%E5%85%A8/"
           data-tag="docker"
           data-author="" >
            <span class="post-title" title="docker大全">docker大全</span>
            <span class="post-date" title="2021-06-05 14:16:33">2021/06/05</span>
        </a>
        
        <a  class="All 工具 "
           href="/2021/05/20/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/redis%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%93%A8%E5%85%B5/redis%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%8F%8A%E5%93%A8%E5%85%B5/"
           data-tag="redis,主从,哨兵"
           data-author="" >
            <span class="post-title" title="redis搭建主从及哨兵">redis搭建主从及哨兵</span>
            <span class="post-date" title="2021-05-20 14:16:33">2021/05/20</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/04/21/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="面试题">面试题</span>
            <span class="post-date" title="2021-04-21 14:16:33">2021/04/21</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/04/19/java%E5%AD%A6%E4%B9%A0/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/"
           data-tag="并发,java"
           data-author="" >
            <span class="post-title" title="并发编程实战">并发编程实战</span>
            <span class="post-date" title="2021-04-19 00:00:00">2021/04/19</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/04/09/java%E5%AD%A6%E4%B9%A0/JNA/%E4%BD%BF%E7%94%A8c%E3%80%81c++%E6%96%B9%E6%B3%95/"
           data-tag="java调用c++方法,JNA"
           data-author="" >
            <span class="post-title" title="JNA的使用">JNA的使用</span>
            <span class="post-date" title="2021-04-09 14:16:33">2021/04/09</span>
        </a>
        
        <a  class="All JVM "
           href="/2021/04/09/java%E5%AD%A6%E4%B9%A0/jvm/JvisualVm%E6%8F%90%E7%A4%BA%E6%97%A0%E6%B3%95%E7%9B%91%E8%A7%86%E6%9C%AC%E5%9C%B0Java%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/"
           data-tag="JvisualVm,JVM"
           data-author="" >
            <span class="post-title" title="JvisualVm提示无法监视本地Java应用程序解决办法">JvisualVm提示无法监视本地Java应用程序解决办法</span>
            <span class="post-date" title="2021-04-09 14:16:33">2021/04/09</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/04/09/java%E5%AD%A6%E4%B9%A0/jvm/RMI%20TCP%20CONNECTION%20%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/"
           data-tag="java调用c++方法,JNA"
           data-author="" >
            <span class="post-title" title="JNA的使用">JNA的使用</span>
            <span class="post-date" title="2021-04-09 14:16:33">2021/04/09</span>
        </a>
        
        <a  class="All 并发、netty "
           href="/2021/03/30/netty/netty%E5%88%86%E5%8C%85%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98/"
           data-tag="锁netty,并发,分包粘包"
           data-author="" >
            <span class="post-title" title="netty分包粘包问题">netty分包粘包问题</span>
            <span class="post-date" title="2021-03-30 14:16:33">2021/03/30</span>
        </a>
        
        <a  class="All JAVA "
           href="/2021/03/08/java%E5%AD%A6%E4%B9%A0/%E4%BD%8D%E8%BF%90%E7%AE%97/%E4%BD%8D%E8%BF%90%E7%AE%97/"
           data-tag="按位与,位运算"
           data-author="" >
            <span class="post-title" title="位运算">位运算</span>
            <span class="post-date" title="2021-03-08 14:16:33">2021/03/08</span>
        </a>
        
        <a  class="All oracle "
           href="/2020/12/17/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/oracle/oracle%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"
           data-tag="sql,函数,oracle"
           data-author="" >
            <span class="post-title" title="oracle基础语法">oracle基础语法</span>
            <span class="post-date" title="2020-12-17 00:00:00">2020/12/17</span>
        </a>
        
        <a  class="All 并发 "
           href="/2020/11/03/%E5%B9%B6%E5%8F%91/Java%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/"
           data-tag="并发,锁机制,死锁"
           data-author="" >
            <span class="post-title" title="Java 并发基础常见面试题总结">Java 并发基础常见面试题总结</span>
            <span class="post-date" title="2020-11-03 14:16:33">2020/11/03</span>
        </a>
        
        <a  class="All 工具 "
           href="/2020/10/28/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/hexo/hexo%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/"
           data-tag="hexo,博客"
           data-author="" >
            <span class="post-title" title="hexo搭建静态博客">hexo搭建静态博客</span>
            <span class="post-date" title="2020-10-28 14:16:33">2020/10/28</span>
        </a>
        
        <a  class="All 工具 "
           href="/2020/10/28/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E8%AF%81%E4%B9%A6/%E8%AF%81%E4%B9%A6%E8%BD%AC%E6%8D%A2/"
           data-tag="pfx,cer"
           data-author="" >
            <span class="post-title" title="证书转换">证书转换</span>
            <span class="post-date" title="2020-10-28 14:16:33">2020/10/28</span>
        </a>
        
        <a  class="All JAVA "
           href="/2020/10/27/java%E5%AD%A6%E4%B9%A0/%E5%B7%A5%E5%85%B7%E5%8C%85%E5%AD%A6%E4%B9%A0/Comparable%E4%B8%8EComparator/"
           data-tag="Comparable,Comparator,排序"
           data-author="" >
            <span class="post-title" title="Comparable与Comparator">Comparable与Comparator</span>
            <span class="post-date" title="2020-10-27 14:16:33">2020/10/27</span>
        </a>
        
        <a  class="All 小程序 "
           href="/2020/10/21/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%9B%B8%E5%85%B3/rsa%E5%88%86%E6%AE%B5%E5%8A%A0%E5%AF%86(%E5%B0%8F%E7%A8%8B%E5%BA%8F+java%E5%90%8E%E5%8F%B0)/"
           data-tag="小程序,RSA分段"
           data-author="" >
            <span class="post-title" title="rsa分段加密（小程序+java后台）">rsa分段加密（小程序+java后台）</span>
            <span class="post-date" title="2020-10-21 14:16:33">2020/10/21</span>
        </a>
        
        <a  class="All 并发 "
           href="/2020/10/21/%E5%B9%B6%E5%8F%91/%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81/"
           data-tag="并发,锁机制"
           data-author="" >
            <span class="post-title" title="悲观锁与乐观锁">悲观锁与乐观锁</span>
            <span class="post-date" title="2020-10-21 14:16:33">2020/10/21</span>
        </a>
        
        <a  class="All oracle "
           href="/2020/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/oracle/oracle%20%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E3%80%81%E8%A1%A8%E7%9A%84%E6%81%A2%E5%A4%8D/"
           data-tag="运维,tag2,tag3"
           data-author="" >
            <span class="post-title" title="oracle 误删数据、表的恢复">oracle 误删数据、表的恢复</span>
            <span class="post-date" title="2020-10-21 14:16:33">2020/10/21</span>
        </a>
        
        <a  class="All 工具 "
           href="/2020/03/25/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E8%81%9A%E5%90%88%E6%94%AF%E4%BB%98%E6%8B%89%E8%B5%B7%E6%B5%81%E7%A8%8B/%E8%81%9A%E5%90%88%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B/"
           data-tag="微信支付,支付宝"
           data-author="" >
            <span class="post-title" title="聚合支付">聚合支付</span>
            <span class="post-date" title="2020-03-25 14:16:33">2020/03/25</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-java学习/性能优化/基准测试工具—JMH使用指南" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">JMH使用指南</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="JAVA">JAVA</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color2">基准测试工具</a>
            
            <a class="color4">JMH</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2022-09-14 17:30:46'>2022-09-13 00:00</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7-%E2%80%94%E2%80%94-JMH%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-text">Java基准测试工具 —— JMH使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E7%A1%80"><span class="toc-text">一、基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Java-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E9%9A%BE%E9%A2%98"><span class="toc-text">1.1 Java 性能测试难题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%9B%B8%E5%85%B3%E7%BD%91%E7%AB%99"><span class="toc-text">1.2 相关网站</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8"><span class="toc-text">二、使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%BC%95%E5%8C%85"><span class="toc-text">2.1 引包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-text">2.2 创建测试类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C%E8%AF%A6%E8%A7%A3"><span class="toc-text">2.3 输出结果详解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%AF%A6%E7%BB%86%E5%8F%82%E6%95%B0"><span class="toc-text">三、详细参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Benchmark"><span class="toc-text">@Benchmark</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Warmup"><span class="toc-text">@Warmup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Measurement"><span class="toc-text">@Measurement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BenchmarkMode"><span class="toc-text">@BenchmarkMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OutputTimeUnit"><span class="toc-text">@OutputTimeUnit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#State"><span class="toc-text">@State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Param"><span class="toc-text">@Param</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fork"><span class="toc-text">@Fork</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Threads"><span class="toc-text">@Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81JMH-%E8%BF%9B%E9%98%B6"><span class="toc-text">四、JMH 进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%94%A8%E4%BB%A3%E7%A0%81%E6%B6%88%E9%99%A4-%EF%BC%88-Dead-Code-Elimination-%EF%BC%89"><span class="toc-text">无用代码消除 （ Dead Code Elimination ）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blackhole-%E9%BB%91%E6%B4%9E"><span class="toc-text">** Blackhole (黑洞)**</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DCE%E7%9A%84%E5%B8%B8%E9%87%8F%E6%8A%98%E5%8F%A0%EF%BC%88constant-folding%EF%BC%89"><span class="toc-text">DCE的常量折叠（constant-folding）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E5%B1%95%E5%BC%80%EF%BC%88Loop-Unwinding%EF%BC%89"><span class="toc-text">** 循环展开（Loop Unwinding）**</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94"><span class="toc-text">方法内联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java基准测试工具-——-JMH使用指南"><a href="#Java基准测试工具-——-JMH使用指南" class="headerlink" title="Java基准测试工具 —— JMH使用指南"></a>Java基准测试工具 —— JMH使用指南</h1><h2 id="一、基础"><a href="#一、基础" class="headerlink" title="一、基础"></a>一、基础</h2><p>JMH（Java Microbenchmark Harness）是Java用来做基准测试一个工具，该工具由<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=openJDK&spm=1001.2101.3001.7020">openJDK</a>提供并维护，精度可以达到纳秒级。该工具是由 Oracle 内部实现 JIT 的大牛们编写的，他们应该比任何人都了解 JIT 以及 JVM 对于基准测试的影响。</p>
<h3 id="1-1-Java-性能测试难题"><a href="#1-1-Java-性能测试难题" class="headerlink" title="1.1 Java 性能测试难题"></a>1.1 Java 性能测试难题</h3><p>现在的 JVM 已经越来越为智能，它可以在编译阶段、加载阶段、运行阶段对代码进行优化。比如你写了一段不怎么聪明的代码，到了 JVM 这里，它发现几处可以优化的地方，就顺手帮你优化了一把。这对程序的运行固然美妙，却让开发者不能准确了解程序的运行情况。在需要进行性能测试时，如果不知道 JVM 优化细节，可能会导致你的测试结果差之毫厘，失之千里，同样的，Java 诞生之初就有一次编译、随处运行的口号，JVM 提供了底层支持，也提供了内存管理机制，这些机制都会对我们的性能测试结果造成不可预测的影响。</p>
<pre><code class="java">long start = System.currentTimeMillis();
// ....
long end = System.currentTimeMillis();
System.out.println(end - start);
</code></pre>
<p>上面可能就是你最常见的性能测试了，这样的测试结果真的准确吗？答案是否定的，它有下面几个问题。</p>
<ol>
<li>时间精度问题，本身获取到的时间戳就是存在<strong>误差</strong>的，它和操作系统有关。</li>
<li>JVM 在运行时会进行<strong>代码预热</strong>，说白了就是<strong>越跑越快</strong>。因为类需要装载、需要准备操作。</li>
<li>JVM 会在各个阶段都有可能对你的代码进行<strong>优化处理</strong>。</li>
<li><strong>资源回收</strong>的不确定性，可能运行很快，回收很慢。</li>
</ol>
<p>带着这些问题，突然发现进行一次严格的基准测试的难度大大增加。那么如何才能进行一次严格的基准测试呢？</p>
<p> <strong>JMH只适合细粒度的方法测试，并不适用于系统之间的链路测试！</strong></p>
<h3 id="1-2-相关网站"><a href="#1-2-相关网站" class="headerlink" title="1.2 相关网站"></a>1.2 相关网站</h3><ul>
<li><a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jmh">JMH 官网</a></li>
<li><a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples">JMH 官方用例</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Childe-Chen/goodGoodStudy/tree/master/src/main/java/com/cxd/benchmark">JMH 官方用例 翻译</a></li>
</ul>
<h2 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h2><h3 id="2-1-引包"><a href="#2-1-引包" class="headerlink" title="2.1 引包"></a>2.1 引包</h3><pre><code class="xml">&lt;!--jmh 基准测试 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;
    &lt;artifactId&gt;jmh-core&lt;/artifactId&gt;
    &lt;version&gt;1.23&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;
    &lt;artifactId&gt;jmh-generator-annprocess&lt;/artifactId&gt;
    &lt;version&gt;1.23&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="2-2-创建测试类"><a href="#2-2-创建测试类" class="headerlink" title="2.2 创建测试类"></a>2.2 创建测试类</h3><p>以下以 <strong>jackson</strong> 转换json为例</p>
<pre><code class="java">@BenchmarkMode(Mode.Throughput) // 测试模式: 计算吞吐量
@State(Scope.Thread) // 类实例的可用范围 默认状态。每个测试线程分配一个实例；
@OutputTimeUnit(TimeUnit.SECONDS) // 输出时间单位
@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS) // 测试前进行三次预热执行
@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS) // 5 次微基准测试
@Fork(1) // 开启一个进程进行测试
@Threads(10) // 测试使用的线程数
public class MyBenchmark &#123;

    String string = &quot;&quot;;
    StringBuilder stringBuilder = new StringBuilder();

    String json = &quot;&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;&quot;;

    @State(Scope.Benchmark) // 所有测试线程共享一个实例，用于测试有状态实例在多线程共享下的性能；
    public static class BenchmarkState &#123;
        ObjectMapper GLOBAL_MAP = new ObjectMapper();
        ThreadLocal&lt;ObjectMapper&gt; GLOBAL_MAP_THREAD = new ThreadLocal&lt;&gt;();
    &#125;

    @Benchmark // 标记测试方法 仅public
    public Map globalTest(BenchmarkState state) throws Exception&#123;
        return state.GLOBAL_MAP.readValue(json, Map.class);
    &#125;

    @Benchmark
    public Map globalTestThreadLocal(BenchmarkState state) throws Exception&#123;
        if(null == state.GLOBAL_MAP_THREAD.get())&#123;
            state.GLOBAL_MAP_THREAD.set(new ObjectMapper());
        &#125;
        return state.GLOBAL_MAP_THREAD.get().readValue(json, Map.class);
    &#125;

    @Benchmark
    public Map localTest() throws Exception&#123;
        ObjectMapper objectMapper = new ObjectMapper();
        return objectMapper.readValue(json, Map.class);
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        // 构建运行参数, 类注解也可以通过此处构造, 且main方法的优先级更高
        Options opt = new OptionsBuilder()
                .include(MyBenchmark.class.getSimpleName())
                .resultFormat(ResultFormatType.CSV) // 生成测试结果(默认在项目根目录下)
                .build();
        new Runner(opt).run();
    &#125;   
&#125;
</code></pre>
<h3 id="2-3-输出结果详解"><a href="#2-3-输出结果详解" class="headerlink" title="2.3 输出结果详解"></a>2.3 输出结果详解</h3><pre><code class="shell"># JMH version: 1.23
# VM version: JDK 1.8.0_211, Java HotSpot(TM) 64-Bit Server VM, 25.211-b12
# VM invoker: D:\xxx\java.exe
# VM options: -javaagent:xxx\IntelliJ IDEA 2021.2.3\bin -Dfile.encoding=UTF-8
# Warmup: 5 iterations, 1 s each  // 预热运行5次
# Measurement: 5 iterations, 1 s each  // 性能测试5次 
# Timeout: 10 min per iteration  // 超时时间10分钟
# Threads: 10 threads, will synchronize iterations // 线程数量为10
# Benchmark mode: Throughput, ops/time // 基准模式 吞吐量  每秒执行多少次
# Benchmark: com.rabbitmqprovider.MyBenchmark.globalTest  // 本次执行的方法

# Run progress: 0.00% complete, ETA 00:00:30
# Fork: 1 of 1
# Warmup Iteration   1: 9206522.065 ops/s // 第一次预热，每秒执行 
# Warmup Iteration   2: 12471685.637 ops/s
# Warmup Iteration   3: 12555179.271 ops/s
# Warmup Iteration   4: 12972906.601 ops/s
# Warmup Iteration   5: 12724755.463 ops/s
Iteration   1: 12394864.584 ops/s  // 执行五次
Iteration   2: 12203348.918 ops/s
Iteration   3: 12755029.102 ops/s
Iteration   4: 12265201.730 ops/s
Iteration   5: 12458625.163 ops/s


Result &quot;com.rabbitmqprovider.MyBenchmark.globalTest&quot;:
  12415413.899 ±(99.9%) 828477.530 ops/s [Average]
  (min, avg, max) = (12203348.918, 12415413.899, 12755029.102), stdev = 215152.984  // 执行的最小、平均、最大、误差值
  CI (99.9%): [11586936.369, 13243891.430] (assumes normal distribution)

....

# Run complete. Total time: 00:00:35

REMEMBER: The numbers below are just data. To gain reusable insights, you need to follow up on
why the numbers are the way they are. Use profilers (see -prof, -lprof), design factorial
experiments, perform baseline and negative tests that provide experimental control, make sure
the benchmarking environment is safe on JVM/OS/HW level, ask for reviews from the domain experts.
Do not assume the numbers tell you what you want them to tell.
// 测试结果对比
// 测试方法                        测试模式 次数          分数          误差    单位
Benchmark                           Mode  Cnt         Score         Error  Units
MyBenchmark.globalTest             thrpt    5  12415413.899 ±  828477.530  ops/s
MyBenchmark.globalTestThreadLocal  thrpt    5  12272055.351 ± 1172156.668  ops/s
MyBenchmark.localTest              thrpt    5    860593.965 ±  164589.608  ops/s

Benchmark result is saved to jmh-result.csv

Process finished with exit code 0
</code></pre>
<p>预热？为什么要预热？因为 JVM 的 JIT 机制的存在，如果某个函数被调用多次之后，JVM 会尝试将其编译成为机器码从而提高执行速度。为了让 benchmark 的结果更加接近真实情况就需要进行预热。</p>
<h2 id="三、详细参数"><a href="#三、详细参数" class="headerlink" title="三、详细参数"></a>三、详细参数</h2><h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="@Benchmark"></a><strong>@Benchmark</strong></h3><p>@Benchmark标签是用来标记测试方法的，只有被这个注解标记的话，该方法才会参与基准测试，但是有一个基本的原则就是被@Benchmark标记的方法必须是public的。</p>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="@Warmup"></a><strong>@Warmup</strong></h3><p>@Warmup用来配置预热的内容，可用于类或者方法上，越靠近执行方法的地方越准确。一般配置warmup的参数有这些：</p>
<ul>
<li>iterations：预热的次数。</li>
<li>time：每次预热的时间。</li>
<li>timeUnit：时间单位，默认是s。</li>
<li>batchSize: 批处理大小，每次操作调用几次方法。</li>
</ul>
<h3 id="Measurement"><a href="#Measurement" class="headerlink" title="@Measurement"></a><strong>@Measurement</strong></h3><p>用来控制实际执行的内容，配置的选项本warmup一样。</p>
<ul>
<li>iteration:  迭代次数</li>
<li>time: 每次测量迭代的时长</li>
<li>timeUnit: 每次测量迭代的时长单位</li>
<li>batchSize: 每次操作基准方法的调用数</li>
</ul>
<h3 id="BenchmarkMode"><a href="#BenchmarkMode" class="headerlink" title="@BenchmarkMode"></a><strong>@BenchmarkMode</strong></h3><p>@BenchmarkMode主要是表示测量的纬度，有以下这些纬度可供选择：</p>
<ul>
<li>Mode.Throughput 吞吐量</li>
<li>Mode.AverageTime 平均时间</li>
<li>Mode.SampleTime 抽样检测</li>
<li>Mode.SingleShotTime 检测一次调用</li>
<li>Mode.All 运用所有的检测模式 在方法级别指定@BenchmarkMode的时候可以一定指定多个纬度，例如： @BenchmarkMode({Mode.Throughput, Mode.AverageTime, Mode.SampleTime, Mode.SingleShotTime})，代表同时在多个纬度对目标方法进行测量。</li>
</ul>
<h3 id="OutputTimeUnit"><a href="#OutputTimeUnit" class="headerlink" title="@OutputTimeUnit"></a><strong>@OutputTimeUnit</strong></h3><p>@OutputTimeUnit代表测量的单位，比如秒级别，毫秒级别，微妙级别等等。一般都使用微妙和毫秒级别的稍微多一点。该注解可以用在方法级别和类级别，当用在类级别的时候会被更加精确的方法级别的注解覆盖，原则就是离目标更近的注解更容易生效。</p>
<h3 id="State"><a href="#State" class="headerlink" title="@State"></a><strong>@State</strong></h3><p>在很多时候我们需要维护一些状态内容，比如在多线程的时候我们会维护一个共享的状态，这个状态值可能会在每隔线程中都一样，也有可能是每个线程都有自己的状态，JMH为我们提供了状态的支持。该注解只能用来标注在类上，因为类作为一个属性的载体。 @State的状态值主要有以下几种：</p>
<ul>
<li>Scope.Benchmark 该状态的意思是会在所有的Benchmark的工作线程中共享变量内容。</li>
<li>Scope.Group 同一个Group的线程可以享有同样的变量</li>
<li>Scope.Thread 每隔线程都享有一份变量的副本，线程之间对于变量的修改不会相互影响。 </li>
</ul>
<p>必须遵循以下四条规则：</p>
<ul>
<li>有无参构造函数(默认构造函数)</li>
<li>必须公共类</li>
<li>如果是内部类，需要是静态内部类</li>
<li>必须使用 @State 注解</li>
</ul>
<pre><code class="java">1.直接在内部类中使用@State作为“PropertyHolder”

public class JMHSample_03_States &#123;

    @State(Scope.Benchmark)
    public static class BenchmarkState &#123;
        volatile double x = Math.PI;
    &#125;

    @State(Scope.Thread)
    public static class ThreadState &#123;
        volatile double x = Math.PI;
    &#125;

    @Benchmark
    public void measureUnshared(ThreadState state) &#123;
        state.x++;
    &#125;

    @Benchmark
    public void measureShared(BenchmarkState state) &#123;
        state.x++;
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_03_States.class.getSimpleName())
                .threads(4)
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;
&#125;

2.在Main类中直接使用@State作为注解，是Main类直接成为“PropertyHolder”
@State(Scope.Thread)
public class JMHSample_04_DefaultState &#123;
    double x = Math.PI;

    @Benchmark
    public void measure() &#123;
        x++;
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_04_DefaultState.class.getSimpleName())
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;
&#125;
</code></pre>
<p>我们试想以下@State的含义，它主要是方便框架来控制变量的过程逻辑，通过@State标示的类都被用作属性的容器，然后框架可以通过自己的控制来配置不同级别的隔离情况。被@Benchmark标注的方法可以有参数，但是参数必须是被@State注解的，就是为了要控制参数的隔离。</p>
<p>但是有些情况下我们需要对参数进行一些初始化或者释放的操作，就像Spring提供的一些init和destory方法一样，JHM也提供有这样的钩子：</p>
<ul>
<li>@Setup 必须标示在@State注解的类内部，表示初始化操作</li>
<li>@TearDown 必须表示在@State注解的类内部，表示销毁操作</li>
</ul>
<p>初始化和销毁的动作都只会执行一次。</p>
<pre><code class="text">@State(Scope.Thread)
public class JMHSample_05_StateFixtures &#123;
    double x;

    @Setup
    public void prepare() &#123;
        x = Math.PI;
    &#125;

    @TearDown
    public void check() &#123;
        assert x &gt; Math.PI : &quot;Nothing changed?&quot;;
    &#125;

    @Benchmark
    public void measureRight() &#123;
        x++;
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_05_StateFixtures.class.getSimpleName())
                .forks(1)
                .jvmArgs(&quot;-ea&quot;)
                .build();

        new Runner(opt).run();
    &#125;
&#125;
</code></pre>
<p>虽然我们可以执行初始化和销毁的动作，但是总是感觉还缺点啥？对，就是初始化的粒度。因为基准测试往往会执行多次，那么能不能保证每次执行方法的时候都初始化一次变量呢？ @Setup和@TearDown提供了以下三种纬度的控制：</p>
<ul>
<li>Level.Trial 只会在个基础测试的前后执行。包括Warmup和Measurement阶段，一共只会执行一次。</li>
<li>Level.Iteration 每次执行记住测试方法的时候都会执行，如果Warmup和Measurement都配置了2次执行的话，那么@Setup和@TearDown配置的方法的执行次数就4次。</li>
<li>Level.Invocation 每个方法执行的前后执行（一般不推荐这么用）</li>
</ul>
<p>通常看到这里我们会比较迷惑Iteration和Invocation区别，我们在配置Warmup的时候默认的时间是的1s，即1s的执行作为一个Iteration，假设每次方法的执行是100ms的话，那么1个Iteration就代表10个Invocation。</p>
<h3 id="Param"><a href="#Param" class="headerlink" title="@Param"></a><strong>@Param</strong></h3><p>在很多情况下，我们需要测试不同的参数的不同结果，但是测试的了逻辑又都是一样的，因此如果我们编写镀铬benchmark的话会造成逻辑的冗余，幸好JMH提供了@Param参数来帮助我们处理这个事情，被@Param注解标示的参数组会一次被benchmark消费到。</p>
<pre><code class="java">@State(Scope.Benchmark)
public class ParamTest &#123;

    @Param(&#123;&quot;1&quot;, &quot;2&quot;, &quot;3&quot;&#125;)
    int testNum;

    @Benchmark
    public String test() &#123;
        return String.valueOf(testNum);
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(ParamTest.class.getSimpleName())
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;
&#125;
</code></pre>
<h3 id="Fork"><a href="#Fork" class="headerlink" title="@Fork"></a><strong>@Fork</strong></h3><p><code>fork</code>出多少个子进程来执行同一基准测试方法</p>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="@Threads"></a><strong>@Threads</strong></h3><p>测试线程的数量，可以配置在方法或者类上，代表执行测试的线程数量。该测试使用的线程数。默认是Runtime.getRuntime().availableProcessors()</p>
<h2 id="四、JMH-进阶"><a href="#四、JMH-进阶" class="headerlink" title="四、JMH 进阶"></a>四、JMH 进阶</h2><p>其实 JVM 做的优化操作远不止上面这些，还有比如常量传播（Constant Propagation）、循环展开（Loop Unwinding）、循环表达式外提（Loop Expression Hoisting）、消除公共子表达式（Common Subexpression Elimination）、本块重排序（Basic Block Reordering）、范围检查消除（Range Check Elimination）等。</p>
<h3 id="无用代码消除-（-Dead-Code-Elimination-）"><a href="#无用代码消除-（-Dead-Code-Elimination-）" class="headerlink" title="无用代码消除 （ Dead Code Elimination ）"></a>无用代码消除 （ Dead Code Elimination ）</h3><p>也有网友形象的翻译成<strong>死代码</strong>，死代码是指那些 JVM 经过检查发现的根本不会使用到的代码。比如下面这个代码片段。</p>
<pre><code class="java">@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class JMHSample_08_DeadCode &#123;

    /*
     * 许多基准测试的垮台是消除代码（DCE）：编译器足够聪明，可以推断出某些计算是多余的，并且完全消除了它们。
幸运的是，JMH提供了适当的基础架构来对抗这一点：返回计算结果将要求JMH处理结果以限制消除死亡代码的消除 (returned results
     are implicitly consumed by Blackholes, see JMHSample_09_Blackholes).
     */

    private double x = Math.PI;

    @Benchmark
    public void baseline() &#123;
        // do nothing, this is a baseline
    &#125;

    @Benchmark
    public void measureWrong() &#123;
        // 错误的， 结果没有用到，被优化掉.
        Math.log(x);
    &#125;

    @Benchmark
    public double measureRight() &#123;
        // 正确的， 结果没被用到
        return Math.log(x);
    &#125;


    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_08_DeadCode.class.getSimpleName())
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;

&#125;
</code></pre>
<p>有的代码没啥用，就在编译器被消除了，但这给我做基准测试带了一些麻烦，比如上面的代码中，<code>baseline </code>和 <code>measureWrong </code>有着相同的性能，因为编译器觉得 <code>measureWrong</code>这段代码执行后没有任何影响，为了效率，就直接消除掉这段代码，但是如果加上return语句，就不会在编译期被去掉，这是我们在写基准测试时需要注意的点。当然也可以用 <code>Blackholes</code> 方法消除</p>
<h3 id="Blackhole-黑洞"><a href="#Blackhole-黑洞" class="headerlink" title="** Blackhole (黑洞)**"></a>** Blackhole (黑洞)**</h3><p>Blackhole会消费传进来的值，不提供任何信息来确定这些值是否在之后被实际使用。 Blackhole处理的事情主要有以下几种：</p>
<ul>
<li>死代码消除：入参应该在每次都被用到，因此编译器就不会把这些参数优化为常量或者在计算的过程中对他们进行其他优化。</li>
<li>处理内存壁：我们需要尽可能减少写的量，因为它会干扰缓存，污染写缓冲区等。 这很可能导致过早地撞到内存壁</li>
</ul>
<p>我们在上面说到需要消除无用代码，那么其中一种方式就是通过Blackhole，我们可以用Blackhole来消费这些返回的结果。</p>
<pre><code class="java">1:返回测试结果，防止编译器优化
@Benchmark
public double measureRight_1() &#123;
    return Math.log(x1) + Math.log(x2);
&#125;

2.通过Blackhole消费中间结果，防止编译器优化
@Benchmark
public void measureRight_2(Blackhole bh) &#123;
    bh.consume(Math.log(x1));
    bh.consume(Math.log(x2));
&#125;
</code></pre>
<h3 id="DCE的常量折叠（constant-folding）"><a href="#DCE的常量折叠（constant-folding）" class="headerlink" title="DCE的常量折叠（constant-folding）"></a>DCE的常量折叠（constant-folding）</h3><p>在对 Java 源文件编译的过程中，编译器通过语法分析，可以发现某些能直接得到计算结果而不会再次更改的代码，然后会将计算结果记录下来，这样在执行的过程中就不需要再次运算了。比如这段代码。</p>
<pre><code class="java">     private double x = Math.PI;
    private final double wrongX = Math.PI;

    @Benchmark
    public double measureWrong_1() &#123;
        // 错误: 源是可以预测的，并且计算是可折叠的。
        return Math.log(Math.PI);
    &#125;

    @Benchmark
    public double measureWrong_2() &#123;
        // 错误: the source is predictable, and computation is foldable.
        return Math.log(wrongX);
    &#125;

    @Benchmark
    public double measureRight() &#123;
        // 正确: the source is not predictable.
        return Math.log(x);
    &#125;
</code></pre>
<p>本例介绍了 <code>constant-folding</code>，即常量折叠，上述代码的 <code>measureWrong_1 </code>和 <code>measureWrong_2</code> 中的运算都是可以预测的值，所以也会在编译期直接替换为计算结果，从而导致基准测试失败，注意 final 修饰的变量也会被折叠。</p>
<h3 id="循环展开（Loop-Unwinding）"><a href="#循环展开（Loop-Unwinding）" class="headerlink" title="** 循环展开（Loop Unwinding）**"></a>** 循环展开（Loop Unwinding）**</h3><p>不要在基准测试的时候使用循环，使用循环就会导致测试结果不准确，原因很复杂，甚至可以单独写一篇文章来介绍。简单能理解的一点是如果使用循环，预热可能就会存在问题。</p>
<pre><code class="java">
/**
 * 基准测试方法中进行循环是坏做法
 **/
@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class JMHSample_11_Loops &#123;

    /*
     * It would be tempting for users to do loops within the benchmarked method.
     * (This is the bad thing Caliper taught everyone). These tests explain why
     * this is a bad idea.
     *
     Looping is done in the hope of minimizing the overhead of calling the
      test method, by doing the operations inside the loop instead of inside
     the method call. Don&#39;t buy this argument; you will see there is more
      magic happening when we allow optimizers to merge the loop iterations.
     *
     * 在基准测试方法中做循环是很诱人的。这是Caliper教给大家的坏事情。以下测试告诉你原因。
     *
     * 循环是为了通过在循环内而不是在方法调用内部进行操作来最小化调用测试方法的开销。？？？
     * 不要买这个论点;当我们允许优化器合并循环迭代时，你会发现有更多的魔法发生。
     */


    int x = 1;
    int y = 2;

    /*
     * This is what you do with JMH.
     */

    @Benchmark
    public int measureRight() &#123;
        return (x + y);
    &#125;


    private int reps(int reps) &#123;
        int s = 0;
        for (int i = 0; i &lt; reps; i++) &#123;
            s += (x + y);
        &#125;
        return s;
    &#125;

    @Benchmark
    @OperationsPerInvocation(1)
    public int measureWrong_1() &#123;
        return reps(1);
    &#125;

    @Benchmark
    @OperationsPerInvocation(10)
    public int measureWrong_10() &#123;
        return reps(10);
    &#125;

    @Benchmark
    @OperationsPerInvocation(100)
    public int measureWrong_100() &#123;
        return reps(100);
    &#125;

    @Benchmark
    @OperationsPerInvocation(1000)
    public int measureWrong_1000() &#123;
        return reps(1000);
    &#125;

    @Benchmark
    @OperationsPerInvocation(10000)
    public int measureWrong_10000() &#123;
        return reps(10000);
    &#125;

    @Benchmark
    @OperationsPerInvocation(100000)
    public int measureWrong_100000() &#123;
        return reps(100000);
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_11_Loops.class.getSimpleName())
                .forks(1)
                .build();
        new Runner(opt).run();
    &#125;

&#125;
</code></pre>
<pre><code class="shell">Benchmark                               Mode  Cnt  Score    Error  Units
JMHSample_11_Loops.measureRight         avgt    5  1.657 ±  0.008  ns/op
JMHSample_11_Loops.measureWrong_1       avgt    5  1.772 ±  0.941  ns/op
JMHSample_11_Loops.measureWrong_10      avgt    5  0.195 ±  0.151  ns/op
JMHSample_11_Loops.measureWrong_100     avgt    5  0.020 ±  0.009  ns/op
JMHSample_11_Loops.measureWrong_1000    avgt    5  0.018 ±  0.001  ns/op
JMHSample_11_Loops.measureWrong_10000   avgt    5  0.017 ±  0.014  ns/op
JMHSample_11_Loops.measureWrong_100000  avgt    5  0.015 ±  0.001  ns/op
</code></pre>
<p>你可能已经注意到，循环次数阅读，统计出来的时间越短。到目前位置，每次操作的时间已经是1/20 ns，远远超过硬件的实际能力。发生这种情况是因为循环被大量<code>unrolled</code>/<code>pipelined</code>，并且要从循环中提升要测量的操作。规则：不要过度使用循环，依靠JMH来正确测量。</p>
<p>我们虽然可以在<code>Benchmark</code>中定义循环逻辑，但是这么做其实是不合适的，因为编译器可能会将我们的循环进行展开或者做一些其他方面的循环优化，所以JHM建议我们不要在<code>Beanchmark</code>中使用循环，如果我们需要处理循环逻辑了，可以结合**@BenchmarkMode(Mode.SingleShotTime)<strong>和</strong>@Measurement(batchSize = N)**来达到同样的效果.</p>
<pre><code class="java">@State(Scope.Thread)
public class JMHSample_26_BatchSize &#123;

    List&lt;String&gt; list = new LinkedList&lt;&gt;();

    // 每个iteration中做5000次Invocation
    @Benchmark
    @Warmup(iterations = 5, batchSize = 5000)
    @Measurement(iterations = 5, batchSize = 5000)
    @BenchmarkMode(Mode.SingleShotTime)
    public List&lt;String&gt; measureRight() &#123;
        list.add(list.size() / 2, &quot;something&quot;);
        return list;
    &#125;

    @Setup(Level.Iteration)
    public void setup()&#123;
        list.clear();
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_26_BatchSize.class.getSimpleName())
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;

&#125;
</code></pre>
<h3 id="方法内联"><a href="#方法内联" class="headerlink" title="方法内联"></a><strong>方法内联</strong></h3><p>方法内联：如果JVM监测到一些小方法被频繁的执行，它会把方法的调用替换成方法体本身。比如说下面这个：</p>
<pre><code class="java">    private int add4(int x1, int x2, int x3, int x4) &#123;
        return add2(x1, x2) + add2(x3, x4);
    &#125;

    private int add2(int x1, int x2) &#123;
        return x1 + x2;
    &#125;
</code></pre>
<p>运行一段时间后JVM会把add2方法去掉，并把你的代码翻译成：</p>
<pre><code class="java">    private int add4(int x1, int x2, int x3, int x4) &#123;
        return x1 + x2 + x3 + x4;
    &#125;
</code></pre>
<p>JMH提供了CompilerControl注解来控制方法内联，但是实际上我感觉比较有用的就是两个了：</p>
<ul>
<li>CompilerControl.Mode.DONT_INLINE：强制限制不能使用内联</li>
<li>CompilerControl.Mode.INLINE：强制使用内联 看一下官方提供的例子</li>
<li>CompilerControl.Mode.EXCLUDE：不编译</li>
</ul>
<pre><code class="java">@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class JMHSample_16_CompilerControl &#123;

    public void target_blank() &#123;

    &#125;

    @CompilerControl(CompilerControl.Mode.DONT_INLINE)
    public void target_dontInline() &#123;

    &#125;

    @CompilerControl(CompilerControl.Mode.INLINE)
    public void target_inline() &#123;

    &#125;
    
    @CompilerControl(CompilerControl.Mode.EXCLUDE)
    public void target_exclude() &#123;

    &#125;

    @Benchmark
    public void baseline() &#123;

    &#125;

    @Benchmark
    public void dontinline() &#123;
        target_dontInline();
    &#125;

    @Benchmark
    public void inline() &#123;
        target_inline();
    &#125;

    public static void main(String[] args) throws RunnerException &#123;
        Options opt = new OptionsBuilder()
                .include(JMHSample_16_CompilerControl.class.getSimpleName())
                .warmupIterations(0)
                .measurementIterations(3)
                .forks(1)
                .build();

        new Runner(opt).run();
    &#125;
&#125;

======================================执行结果==============================
Benchmark                                Mode  Cnt  Score   Error  Units
JMHSample_16_CompilerControl.baseline    avgt    3  0.896 ± 3.426  ns/op
JMHSample_16_CompilerControl.dontinline  avgt    3  0.344 ± 0.126  ns/op
JMHSample_16_CompilerControl.inline      avgt    3  0.391 ± 2.622  ns/op
JMHSample_16_CompilerControl.exclude     avgt    3 52.937 ± 5.622  ns/op
======================================执行结果==============================
</code></pre>
<p>本例提到了JVM的方法内联，简单来说比较短但是执行频率又很高的方法，在执行多次后，JVM将该方法的调用替换为本身，以减少出栈入栈，从而减少性能的消耗。但是Java方法内联是无法人为控制的。</p>
<p>从执行结果可以看到内联方法和空方法执行速度一样，不编译执行最慢。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/885895#slide-7">JMH - Java 代码性能测试的终极利器、必须掌握</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq1620657419/article/details/111669194">Java基准测试工具 —— JMH使用指南</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/899469">基准测试神器JMH —— 详解36个官方例子</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/66170204">https://zhuanlan.zhihu.com/p/66170204</a></li>
</ul>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 monk6658@163.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">💰</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    学如逆水行舟，不进则退
</p>
<!--<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>-->

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
